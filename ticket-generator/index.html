<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background-color: #2C2E3B;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
            border-bottom: 3px solid #4CAF50;
        }

        /* Input Section */
        .input-section {
            background-color: #2C2E3B;
            padding: 30px;
            border-radius: 0 0 8px 8px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #bbb;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select {
            padding: 12px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            background-color: rgba(255, 255, 255, 0.08);
        }

        .generate-btn {
            width: 100%;
            padding: 14px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .generate-btn:hover {
            background-color: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Preview Section */
        .preview-section {
            background-color: #2C2E3B;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        .preview-container {
            display: inline-block;
            margin: 0 auto;
        }

        /* Receipt Styles */
        .receipt {
            background-color: #3a3a3a;
            color: #fff;
            padding: 40px;
            border-radius: 8px;
            max-width: 600px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #555;
        }

        .receipt-logo {
            width: 80px;
            height: 80px;
            background-color: #d3d3d3;
            border-radius: 50%;
            margin: 0 auto 20px;
        }

        .receipt h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .receipt h2 {
            font-size: 28px;
            margin-bottom: 30px;
        }

        .receipt-content {
            text-align: left;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .receipt-details {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }

        .receipt-details table {
            width: 100%;
            color: #fff;
        }

        .receipt-details td {
            padding: 10px 0;
        }

        .receipt-details td:first-child {
            font-weight: 600;
            color: #bbb;
            width: 40%;
        }

        /* Ticket Styles */
        .ticket {
            background-color: #E85D4B;
            color: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(232, 93, 75, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 36px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1;
        }

        .ticket-event {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
            margin-top: 20px;
            line-height: 1.1;
        }

        .ticket-venue {
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .ticket-divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.4);
            margin: 20px 0;
        }

        .ticket-type {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .ticket-datetime {
            margin: 20px 0 30px 0;
        }

        .ticket-datetime div {
            font-size: 18px;
            margin: 5px 0;
            font-weight: 300;
        }

        .ticket-content-area {
            text-align: center;
        }

        .ticket-crossed {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
        }

        .crossed-box {
            width: 200px;
            height: 200px;
            background-color: white;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .crossed-box canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .ticket-expired {
            text-align: center;
            font-size: 16px;
            margin: 30px 0;
            line-height: 1.4;
            font-weight: 300;
        }

        .ticket-owner {
            font-size: 20px;
            margin-top: 40px;
            font-weight: 400;
        }

        .ticket-number {
            font-size: 36px;
            font-weight: 700;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .ticket-qr {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            display: inline-block;
            margin: 30px auto;
            text-align: center;
        }

        .corner-fold {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 60px 60px;
            border-color: transparent transparent #2C2E3B transparent;
        }

        /* Utilities */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align: center; margin: 30px 0; font-size: 36px; color: #fff;">Ticket Generator</h1>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('receipt')">Quittung</button>
        <button class="tab" onclick="switchTab('ticket')">Ticket</button>
    </div>

    <div class="input-section">
        <!-- URL Import Section -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="urlImport">Resident Advisor URL (Optional)</label>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <input type="url" id="urlImport" placeholder="z.B. https://ra.co/events/12345" 
                       style="flex: 1; padding: 12px; background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff; font-size: 14px;">
                <button type="button" onclick="fetchEventFromURL()" style="padding: 12px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;">Laden</button>
            </div>
            <div id="urlStatus" style="margin-top: 8px; font-size: 12px; color: #888;"></div>
        </div>

        <!-- HTML Import Section -->
        <div class="form-group" style="margin-bottom: 25px;">
            <label for="htmlImport">HTML Import (Optional)</label>
            <textarea id="htmlImport" placeholder="Füge hier HTML Code ein (z.B. von Resident Advisor) um Event-Informationen automatisch zu extrahieren..." 
                     style="min-height: 80px; resize: vertical; font-family: monospace; font-size: 12px; padding: 12px; background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; color: #fff;" 
                     oninput="parseHTMLContent()"></textarea>
            <button type="button" onclick="clearHTMLImport()" style="margin-top: 8px; padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Leeren</button>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="event">Veranstaltung</label>
                <input type="text" id="event" placeholder="z.B. Juliane Wolf invites| Feb '25">
            </div>
            <div class="form-group">
                <label for="showExpired">Als abgelaufen anzeigen</label>
                <select id="showExpired">
                    <option value="no">Nein (mit QR-Code)</option>
                    <option value="yes">Ja (durchgestrichen)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" placeholder="z.B. Club Ritter Butzke">
            </div>
            <div class="form-group">
                <label for="date">Start Datum/Zeit</label>
                <input type="datetime-local" id="date">
            </div>
            <div class="form-group">
                <label for="endDate">End Datum/Zeit (Optional)</label>
                <input type="datetime-local" id="endDate">
            </div>
            <div class="form-group">
                <label for="owner">Eigentümer</label>
                <input type="text" id="owner" placeholder="z.B. Martin Pfeffer">
            </div>
            <div class="form-group">
                <label for="ticketType">Ticket Typ</label>
                <select id="ticketType">
                    <option value="Final release">Final release</option>
                    <option value="Advance ticket">Advance ticket</option>
                    <option value="Regular ticket">Regular ticket</option>
                    <option value="VIP ticket">VIP ticket</option>
                </select>
            </div>
            <div class="form-group">
                <label for="orderNumber">Bestellnummer</label>
                <input type="text" id="orderNumber" placeholder="z.B. KNBEJL">
            </div>
            <div class="form-group">
                <label for="ticketCount">Anzahl Tickets</label>
                <input type="number" id="ticketCount" placeholder="z.B. 2" value="1" min="1">
            </div>
            <div class="form-group">
                <label for="price">Preis</label>
                <input type="text" id="price" placeholder="z.B. 15,00 €">
            </div>
            <div class="form-group">
                <label for="ticketNumber">Ticket Nummer (Optional)</label>
                <input type="text" id="ticketNumberInput" placeholder="z.B. 1234 oder leer lassen">
            </div>
        </div>
        <button class="generate-btn" onclick="generatePreview()">Generieren</button>
    </div>

    <div class="preview-section">
        <div id="receiptPreview" class="preview-container">
            <div class="receipt">
                <div class="receipt-header">
                    <div class="receipt-logo"></div>
                    <h1 id="receiptEvent">Veranstaltung</h1>
                    <h2>Zahlung erhalten für die Bestellung: <span id="receiptOrder">XXXXX</span></h2>
                </div>
                <div class="receipt-content">
                    <p>Hallo,</p>
                    <br>
                    <p>wir haben Ihre Zahlung für <span id="receiptEventText">Veranstaltung</span> erfolgreich erhalten. Vielen Dank!</p>
                    <br>
                    <p>Sie können Ihre Bestellung unter folgender Adresse ändern und einsehen: <br>
                        <a href="#" id="receiptLink" style="color: #4CAF50; word-break: break-all;">https://tickets.ritter-butzke.com/event-link/order/XXXXX/token/</a></p>
                    <br>
                    <p>Viele Grüße,<br>
                        Dein <span id="receiptTeam">Club</span> Team</p>
                </div>
                <div class="receipt-details">
                    <p style="margin-bottom: 20px;">Sie erhalten diese E-Mail, weil Sie eine Bestellung für die folgende Veranstaltung getätigt haben:</p>
                    <table>
                        <tr>
                            <td>Veranstaltung:</td>
                            <td id="receiptEventDetail">Veranstaltung</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td id="receiptDateTime">Datum und Uhrzeit</td>
                        </tr>
                        <tr>
                            <td>Bestellnummer:</td>
                            <td id="receiptOrderDetail">XXXXX (01.01.2025)</td>
                        </tr>
                        <tr>
                            <td>Details:</td>
                            <td id="receiptTicketDetails">1x Ticket</td>
                        </tr>
                        <tr>
                            <td>Preis:</td>
                            <td id="receiptPrice">0,00 €</td>
                        </tr>
                        <tr>
                            <td>Kontakt:</td>
                            <td id="receiptLocation">Location</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td id="receiptEmail">tickets@venue.de</td>
                        </tr>
                    </table>
                    <div style="text-align: center; margin-top: 30px;">
                        <button style="background: none; border: 1px solid #888; color: #fff; padding: 12px 30px; border-radius: 30px; font-size: 16px; cursor: pointer;">
                            Bestelldetails anzeigen
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ticketPreview" class="preview-container hidden">
            <div class="ticket">
                <div class="close-btn">×</div>
                <div class="ticket-event" id="ticketEvent">Veranstaltung</div>
                <div class="ticket-venue" id="ticketVenue">at Location</div>
                <div class="ticket-divider"></div>
                <div class="ticket-type" id="ticketTypeDisplay">Ticket Type</div>
                <div class="ticket-datetime">
                    <div id="ticketDate">So, 15 Okt. 2022</div>
                    <div id="ticketTime">22:00 - 10:00</div>
                </div>
                <div class="ticket-content-area" id="ticketContentArea">
                    <div class="ticket-crossed" id="ticketCrossed">
                        <div class="crossed-box">
                            <div id="qrcodeExpired"></div>
                        </div>
                    </div>
                    <div class="ticket-expired" id="ticketExpired">
                        This event has now passed and the<br>
                        ticket is no longer valid.
                    </div>
                    <div class="ticket-qr hidden" id="ticketQR">
                        <div id="qrcode"></div>
                    </div>
                </div>
                <div class="ticket-owner" id="ticketOwner">Eigentümer</div>
                <div class="ticket-number" id="ticketNumber">1 of 1</div>
                <div class="corner-fold"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentTab = 'receipt';

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        if (tab === 'receipt') {
            document.getElementById('receiptPreview').classList.remove('hidden');
            document.getElementById('ticketPreview').classList.add('hidden');
        } else {
            document.getElementById('receiptPreview').classList.add('hidden');
            document.getElementById('ticketPreview').classList.remove('hidden');
        }

        generatePreview();
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        const months = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sept', 'Okt', 'Nov', 'Dez'];
        const monthsFull = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

        return {
            full: `${date.getDate()}. ${monthsFull[date.getMonth()]} ${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`,
            short: `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}. ${date.getFullYear()}`,
            time: `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`,
            orderDate: `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`
        };
    }

    function generatePreview() {
        const event = document.getElementById('event').value || 'Veranstaltung';
        const location = document.getElementById('location').value || 'Location';
        const date = document.getElementById('date').value;
        const endDate = document.getElementById('endDate').value;
        const owner = document.getElementById('owner').value || 'Eigentümer';
        const ticketType = document.getElementById('ticketType').value || 'Regular ticket';
        const ticketCount = document.getElementById('ticketCount').value || '1';
        const orderNumber = document.getElementById('orderNumber').value || 'XXXXX';
        const showExpired = document.getElementById('showExpired').value;
        const price = document.getElementById('price').value || '0,00 €';

        const dateFormatted = date ? formatDate(date) : {
            full: 'Datum und Uhrzeit',
            short: 'Datum',
            time: '00:00',
            orderDate: '01.01.2025'
        };

        const endDateFormatted = endDate ? formatDate(endDate) : null;

        if (currentTab === 'receipt') {
            // Update Receipt
            document.getElementById('receiptEvent').textContent = event;
            document.getElementById('receiptOrder').textContent = orderNumber;
            document.getElementById('receiptEventText').textContent = event;
            document.getElementById('receiptTeam').textContent = location;
            document.getElementById('receiptEventDetail').textContent = event;
            
            // Display date and time range in receipt
            let receiptDateTime;
            if (endDateFormatted) {
                receiptDateTime = `${dateFormatted.full} - ${endDateFormatted.time}`;
            } else {
                receiptDateTime = dateFormatted.full;
            }
            document.getElementById('receiptDateTime').textContent = receiptDateTime;
            document.getElementById('receiptOrderDetail').textContent = `${orderNumber} (${dateFormatted.orderDate})`;
            document.getElementById('receiptLocation').textContent = location;
            
            // Generate venue-based email address
            const emailDomain = location.toLowerCase()
                .replace(/[äöüß]/g, match => ({'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'}[match] || match))
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
            document.getElementById('receiptEmail').textContent = `tickets@${emailDomain}.de`;
            
            // Update ticket count and price with proper formatting
            const ticketText = ticketCount == 1 ? `${ticketCount}x ${ticketType}` : `${ticketCount}x ${ticketType}s`;
            document.getElementById('receiptTicketDetails').textContent = ticketText;
            
            // Format price properly if it doesn't already have Euro symbol
            let formattedPrice = price;
            if (price && !price.includes('€')) {
                // Try to parse as number and format
                const numPrice = parseFloat(price.replace(',', '.'));
                if (!isNaN(numPrice)) {
                    formattedPrice = numPrice.toFixed(2).replace('.', ',') + ' €';
                }
            }
            document.getElementById('receiptPrice').textContent = formattedPrice;
            
            // Generate venue-based domain and realistic link
            const locationSlug = location.toLowerCase()
                .replace(/[äöüß]/g, match => ({'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'}[match] || match))
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
            const eventSlug = event.toLowerCase()
                .replace(/[äöüß]/g, match => ({'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'}[match] || match))
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 50); // Limit length for realistic URLs
            const randomToken = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 8);
            const receiptLink = `https://tickets.${locationSlug}.com/${eventSlug}/order/${orderNumber}/token/${randomToken}/`;
            document.getElementById('receiptLink').textContent = receiptLink;
            document.getElementById('receiptLink').href = receiptLink;
        } else {
            // Update Ticket
            document.getElementById('ticketEvent').textContent = event;
            document.getElementById('ticketVenue').textContent = `at ${location}`;
            document.getElementById('ticketTypeDisplay').textContent = ticketType;
            document.getElementById('ticketDate').textContent = dateFormatted.short;
            
            // Display time range
            let timeDisplay;
            if (endDateFormatted) {
                timeDisplay = `${dateFormatted.time} - ${endDateFormatted.time}`;
            } else {
                timeDisplay = `${dateFormatted.time} - 10:00`;
            }
            document.getElementById('ticketTime').textContent = timeDisplay;
            document.getElementById('ticketOwner').textContent = owner;
            
            // Handle ticket numbering based on input
            const customTicketNumber = document.getElementById('ticketNumberInput').value.trim();
            
            if (customTicketNumber) {
                // Use custom ticket number
                if (ticketCount == 1) {
                    document.getElementById('ticketNumber').textContent = `#${customTicketNumber}`;
                } else {
                    const currentTicketNum = Math.floor(Math.random() * parseInt(ticketCount)) + 1;
                    document.getElementById('ticketNumber').textContent = `${currentTicketNum} of ${ticketCount} • #${customTicketNumber}`;
                }
            } else {
                // No ticket number - just show count if multiple tickets
                if (ticketCount == 1) {
                    document.getElementById('ticketNumber').textContent = ``;
                } else {
                    const currentTicketNum = Math.floor(Math.random() * parseInt(ticketCount)) + 1;
                    document.getElementById('ticketNumber').textContent = `${currentTicketNum} of ${ticketCount}`;
                }
            }

            // Generate QR Code for both expired and active tickets
            const qrText = `${event} - ${location} - ${dateFormatted.full} - ${owner} - ${ticketType} - ${orderNumber}`;

            // Toggle zwischen abgelaufen und aktiv
            if (showExpired === 'yes') {
                document.getElementById('ticketCrossed').classList.remove('hidden');
                document.getElementById('ticketExpired').classList.remove('hidden');
                document.getElementById('ticketQR').classList.add('hidden');
                
                // Generate QR Code for expired ticket
                const qrContainerExpired = document.getElementById('qrcodeExpired');
                qrContainerExpired.innerHTML = '';
                
                const canvasExpired = document.createElement('canvas');
                qrContainerExpired.appendChild(canvasExpired);
                
                try {
                    const qrExpired = new QRious({
                        element: canvasExpired,
                        value: qrText,
                        size: 160,
                        background: 'white',
                        foreground: 'black',
                        level: 'H'
                    });
                } catch (e) {
                    // Fallback wenn QRious nicht lädt
                    canvasExpired.width = 160;
                    canvasExpired.height = 160;
                    const ctx = canvasExpired.getContext('2d');
                    ctx.fillStyle = '#000';
                    // Create more realistic QR pattern
                    const patterns = [
                        [1,1,1,1,1,1,1,0,0,1,1,1,1,1,1],
                        [1,0,0,0,0,0,1,0,0,1,0,0,0,0,1],
                        [1,0,1,1,1,0,1,0,0,1,0,1,1,1,0],
                        [1,0,1,1,1,0,1,0,0,1,0,1,1,1,0],
                        [1,0,1,1,1,0,1,0,0,1,0,1,1,1,0],
                        [1,0,0,0,0,0,1,0,0,1,0,0,0,0,1],
                        [1,1,1,1,1,1,1,0,1,0,1,0,1,0,1],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                        [0,0,1,0,1,1,0,1,1,0,1,0,0,1,1],
                        [1,0,0,1,1,0,1,0,0,1,0,1,1,0,0],
                        [0,1,1,0,0,1,0,1,1,0,1,0,0,1,1],
                        [1,0,0,1,1,0,1,0,0,1,0,1,1,0,0],
                        [0,1,1,0,0,1,0,1,1,0,1,0,0,1,1],
                        [1,0,0,1,1,0,1,0,0,1,0,1,1,0,0],
                        [1,1,1,1,1,1,1,0,1,0,1,0,1,0,1]
                    ];
                    for (let i = 0; i < 15; i++) {
                        for (let j = 0; j < 15; j++) {
                            if (patterns[i][j]) {
                                ctx.fillRect(j * 10.6, i * 10.6, 10.6, 10.6);
                            }
                        }
                    }
                }
            } else {
                document.getElementById('ticketCrossed').classList.add('hidden');
                document.getElementById('ticketExpired').classList.add('hidden');
                document.getElementById('ticketQR').classList.remove('hidden');

                // Generate QR Code

                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';

                // Canvas für QR-Code erstellen
                const canvas = document.createElement('canvas');
                qrContainer.appendChild(canvas);

                try {
                    const qr = new QRious({
                        element: canvas,
                        value: qrText,
                        size: 180,
                        background: 'white',
                        foreground: 'black',
                        level: 'H'
                    });
                } catch (e) {
                    // Fallback wenn QRious nicht lädt
                    canvas.width = 180;
                    canvas.height = 180;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#000';
                    for (let i = 0; i < 15; i++) {
                        for (let j = 0; j < 15; j++) {
                            if (Math.random() > 0.5) {
                                ctx.fillRect(i * 12, j * 12, 12, 12);
                            }
                        }
                    }
                }

                // Info-Text unter QR-Code
                const infoText = document.createElement('div');
                infoText.style.fontSize = '10px';
                infoText.style.color = '#000';
                infoText.style.marginTop = '5px';
                infoText.textContent = orderNumber;
                qrContainer.appendChild(infoText);
            }
        }
    }

    function getNextFridayOrSaturday() {
        const now = new Date();
        const dayOfWeek = now.getDay();
        let daysToAdd;
        
        if (dayOfWeek <= 5) { // Sunday (0) to Friday (5)
            daysToAdd = 5 - dayOfWeek; // Days until Friday
        } else { // Saturday (6)
            daysToAdd = 6; // Next Saturday
        }
        
        const nextDate = new Date(now);
        nextDate.setDate(now.getDate() + daysToAdd);
        nextDate.setHours(22, 0, 0, 0); // Set time to 22:00
        
        return nextDate;
    }

    // Initialize with default values
    window.onload = function() {
        const nextEvent = getNextFridayOrSaturday();
        document.getElementById('date').value = nextEvent.toISOString().slice(0, 16);
        document.getElementById('event').value = 'Stil vor Talent: Oliver ...';
        document.getElementById('location').value = 'Ritter Butzke';
        document.getElementById('owner').value = 'Martin Pfeffer';
        document.getElementById('ticketType').value = 'Final release';
        document.getElementById('ticketCount').value = '1';
        // Generate more realistic order number
        const orderNum = 'RB' + (Math.floor(Math.random() * 900000) + 100000).toString();
        document.getElementById('orderNumber').value = orderNum;
        document.getElementById('showExpired').value = 'no';
        document.getElementById('price').value = '15,00 €';
        document.getElementById('ticketNumberInput').value = '';

        setTimeout(() => {
            generatePreview();
        }, 300);
    };

    function parseHTMLContent() {
        const htmlContent = document.getElementById('htmlImport').value;
        if (!htmlContent.trim()) return;

        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            // Extract event information from the HTML
            const eventInfo = extractEventInfo(doc);
            
            // Populate form fields with extracted data
            if (eventInfo.event) {
                document.getElementById('event').value = eventInfo.event;
            }
            if (eventInfo.venue) {
                // Use venue name as location (preferred over address)
                document.getElementById('location').value = eventInfo.venue;
            } else if (eventInfo.location) {
                document.getElementById('location').value = eventInfo.location;
            }
            if (eventInfo.date) {
                document.getElementById('date').value = eventInfo.date;
            }
            if (eventInfo.endDate) {
                document.getElementById('endDate').value = eventInfo.endDate;
            }
            if (eventInfo.price) {
                document.getElementById('price').value = eventInfo.price;
            }

            // Auto-generate preview after parsing
            setTimeout(() => {
                generatePreview();
            }, 100);

        } catch (error) {
            console.error('Error parsing HTML:', error);
        }
    }

    function extractEventInfo(doc) {
        const eventInfo = {};

        // Extract event title - try multiple selectors
        const titleSelectors = [
            'h1[data-testid="event-title"]',
            'h1.event-title',
            'h1',
            '.event-title',
            '[data-testid="event-title"]'
        ];
        
        for (const selector of titleSelectors) {
            const titleElement = doc.querySelector(selector);
            if (titleElement && titleElement.textContent.trim()) {
                eventInfo.event = titleElement.textContent.trim();
                break;
            }
        }

        // Extract venue/location information
        const venueSelectors = [
            '[data-testid="event-venue"]',
            '.venue-name',
            '.location',
            '.event-venue',
            // RA-specific selectors
            'a[href*="/clubs/"]',
            'a[data-pw-test-id="event-venue-link"]',
            // Rausgegangen-specific selectors
            'a[href*="/locations/"]',
            '.color-blue[href*="/locations/"]'
        ];
        
        for (const selector of venueSelectors) {
            const venueElement = doc.querySelector(selector);
            if (venueElement && venueElement.textContent.trim()) {
                eventInfo.venue = venueElement.textContent.trim();
                break;
            }
        }

        // Extract address - try multiple approaches for RA and Rausgegangen
        const addressSelectors = [
            '[data-testid="event-address"]',
            '.venue-address',
            '.address',
            '.location-address'
        ];
        
        for (const selector of addressSelectors) {
            const addressElement = doc.querySelector(selector);
            if (addressElement && addressElement.textContent.trim()) {
                eventInfo.location = addressElement.textContent.trim();
                break;
            }
        }
        
        // Special handling for RA structure - look for address in event details area
        if (!eventInfo.location) {
            const eventDetailsGrid = doc.querySelector('.fevhZX, [class*="grid"]');
            if (eventDetailsGrid) {
                const addressText = eventDetailsGrid.textContent;
                // Look for address pattern (Straße + PLZ + Stadt)
                const addressMatch = addressText.match(/([A-Za-zäöüß\s]+\.?\s*\d+[a-z]?,?\s*\d{5}\s*[A-Za-zäöüß\s]+)/);
                if (addressMatch) {
                    eventInfo.location = addressMatch[1].trim();
                }
            }
        }
        
        // Special handling for Rausgegangen structure - look for address in location section
        if (!eventInfo.location) {
            // Find location section and extract address
            const locationSection = doc.querySelector('.event-location-image')?.parentElement;
            if (locationSection) {
                const addressSpans = locationSection.querySelectorAll('span');
                for (const span of addressSpans) {
                    const text = span.textContent.trim();
                    // Look for address pattern in Rausgegangen format
                    if (text.match(/\d{5}\s+Berlin/) || text.includes('Berlin-')) {
                        eventInfo.location = text;
                        break;
                    }
                }
            }
        }

        // Extract date and time from script tags (common in RA and Rausgegangen pages)
        const scriptTags = doc.querySelectorAll('script');
        for (const script of scriptTags) {
            const scriptContent = script.textContent || script.innerHTML;
            
            // Look for ISO date patterns (RA format)
            const isoDateMatch = scriptContent.match(/"startDate":"([^"]+)"/);
            if (isoDateMatch) {
                try {
                    const date = new Date(isoDateMatch[1]);
                    eventInfo.date = date.toISOString().slice(0, 16);
                } catch (e) {
                    // Continue to next script
                }
            }
            
            // Look for end date (RA format)
            const isoEndDateMatch = scriptContent.match(/"endDate":"([^"]+)"/);
            if (isoEndDateMatch) {
                try {
                    const endDate = new Date(isoEndDateMatch[1]);
                    eventInfo.endDate = endDate.toISOString().slice(0, 16);
                } catch (e) {
                    // Continue to next script
                }
            }
            
            // Look for Rausgegangen JSON-LD structured data
            if (scriptContent.includes('"@type": "Event"')) {
                const startDateMatch = scriptContent.match(/"startDate":\s*"([^"]+)"/);
                const endDateMatch = scriptContent.match(/"endDate":\s*"([^"]+)"/);
                
                if (startDateMatch) {
                    try {
                        const date = new Date(startDateMatch[1]);
                        eventInfo.date = date.toISOString().slice(0, 16);
                    } catch (e) {
                        // Continue
                    }
                }
                
                if (endDateMatch) {
                    try {
                        const endDate = new Date(endDateMatch[1]);
                        eventInfo.endDate = endDate.toISOString().slice(0, 16);
                    } catch (e) {
                        // Continue
                    }
                }
            }
            
            if (eventInfo.date) break;
            
            // Look for other date patterns
            const dateMatch = scriptContent.match(/"date":"([^"]+)"/);
            if (dateMatch) {
                try {
                    const date = new Date(dateMatch[1]);
                    eventInfo.date = date.toISOString().slice(0, 16);
                    break;
                } catch (e) {
                    // Continue to next script
                }
            }
        }

        // Try to extract date from text content if not found in scripts
        if (!eventInfo.date) {
            const dateSelectors = [
                '[data-testid="event-date"]',
                '.event-date',
                '.date',
                'time'
            ];
            
            for (const selector of dateSelectors) {
                const dateElement = doc.querySelector(selector);
                if (dateElement) {
                    const dateText = dateElement.textContent.trim();
                    const dateTime = dateElement.getAttribute('datetime');
                    
                    if (dateTime) {
                        try {
                            const date = new Date(dateTime);
                            eventInfo.date = date.toISOString().slice(0, 16);
                            break;
                        } catch (e) {
                            // Continue
                        }
                    }
                    
                    // Try to parse date from text
                    if (dateText) {
                        try {
                            const date = new Date(dateText);
                            if (!isNaN(date.getTime())) {
                                eventInfo.date = date.toISOString().slice(0, 16);
                                break;
                            }
                        } catch (e) {
                            // Continue
                        }
                    }
                }
            }
            
            // Special handling for Rausgegangen date format in sidebar
            if (!eventInfo.date) {
                const dateTimeElement = doc.querySelector('.w-full.flex.flex-col.ml-4');
                if (dateTimeElement) {
                    const dateSpans = dateTimeElement.querySelectorAll('span');
                    for (const span of dateSpans) {
                        const text = span.textContent.trim();
                        // Look for patterns like "Morgen, 20. Jun 2025, 18:00 -"
                        const dateMatch = text.match(/(\d{1,2})\.\s*(\w{3})\s*(\d{4}),?\s*(\d{1,2}):(\d{2})/);
                        if (dateMatch) {
                            const [, day, monthStr, year, hour, minute] = dateMatch;
                            const monthMap = {
                                'Jan': 0, 'Feb': 1, 'Mär': 2, 'Apr': 3, 'Mai': 4, 'Jun': 5,
                                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Okt': 9, 'Nov': 10, 'Dez': 11
                            };
                            if (monthMap.hasOwnProperty(monthStr)) {
                                try {
                                    const date = new Date(parseInt(year), monthMap[monthStr], parseInt(day), parseInt(hour), parseInt(minute));
                                    eventInfo.date = date.toISOString().slice(0, 16);
                                    break;
                                } catch (e) {
                                    // Continue
                                }
                            }
                        }
                    }
                }
            }
        }

        // Extract artist information and append to event name if available
        const artistSelectors = [
            '.artist-name',
            '.lineup-artist',
            '[data-testid="artist"]'
        ];
        
        for (const selector of artistSelectors) {
            const artistElement = doc.querySelector(selector);
            if (artistElement && artistElement.textContent.trim()) {
                const artist = artistElement.textContent.trim();
                if (eventInfo.event && !eventInfo.event.includes(artist)) {
                    eventInfo.event += ' - ' + artist;
                }
                break;
            }
        }
        
        // Extract price information
        const priceSelectors = [
            '.text-primary:not(.truncate)', // Rausgegangen price display
            '.price',
            '.ticket-price',
            '[data-testid="event-price"]'
        ];
        
        for (const selector of priceSelectors) {
            const priceElement = doc.querySelector(selector);
            if (priceElement && priceElement.textContent.trim()) {
                const priceText = priceElement.textContent.trim();
                // Check if it contains price pattern
                if (priceText.match(/\d+[,.]?\d*\s*€/) || priceText.includes('€')) {
                    eventInfo.price = priceText;
                    break;
                }
            }
        }
        
        // Look for price in structured data
        if (!eventInfo.price) {
            const scriptTags = doc.querySelectorAll('script');
            for (const script of scriptTags) {
                const scriptContent = script.textContent || script.innerHTML;
                if (scriptContent.includes('"@type": "Event"') || scriptContent.includes('"@type": "Offer"')) {
                    const priceMatch = scriptContent.match(/"price":\s*(\d+(?:\.\d+)?)/);
                    if (priceMatch) {
                        eventInfo.price = priceMatch[1] + ',00 €';
                        break;
                    }
                }
            }
        }

        return eventInfo;
    }

    function clearHTMLImport() {
        document.getElementById('htmlImport').value = '';
    }

    async function fetchEventFromURL() {
        const urlInput = document.getElementById('urlImport');
        const statusDiv = document.getElementById('urlStatus');
        const url = urlInput.value.trim();

        if (!url) {
            statusDiv.textContent = 'Bitte gebe eine URL ein';
            statusDiv.style.color = '#ff6b6b';
            return;
        }

        // Validate URL format
        if (!url.includes('ra.co/events/') && !url.includes('rausgegangen.de/events/')) {
            statusDiv.textContent = 'Bitte gebe eine gültige Resident Advisor oder Rausgegangen Event-URL ein';
            statusDiv.style.color = '#ff6b6b';
            return;
        }

        statusDiv.textContent = 'Lade Event-Daten...';
        statusDiv.style.color = '#4CAF50';

        try {
            // Use CORS proxy to fetch the page
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
            const response = await fetch(proxyUrl);
            
            if (!response.ok) {
                throw new Error('Fehler beim Laden der Seite');
            }

            const data = await response.json();
            const htmlContent = data.contents;

            // Parse the fetched HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const eventInfo = extractEventInfo(doc);

            // Populate form fields
            let fieldsUpdated = 0;
            if (eventInfo.event) {
                document.getElementById('event').value = eventInfo.event;
                fieldsUpdated++;
            }
            if (eventInfo.venue) {
                // Use venue name as location (preferred over address)
                document.getElementById('location').value = eventInfo.venue;
                fieldsUpdated++;
            } else if (eventInfo.location) {
                document.getElementById('location').value = eventInfo.location;
                fieldsUpdated++;
            }
            if (eventInfo.date) {
                document.getElementById('date').value = eventInfo.date;
                fieldsUpdated++;
            }
            if (eventInfo.endDate) {
                document.getElementById('endDate').value = eventInfo.endDate;
                fieldsUpdated++;
            }
            if (eventInfo.price) {
                document.getElementById('price').value = eventInfo.price;
                fieldsUpdated++;
            }

            if (fieldsUpdated > 0) {
                statusDiv.textContent = `Event-Daten erfolgreich geladen (${fieldsUpdated} Felder aktualisiert)`;
                statusDiv.style.color = '#4CAF50';
                
                // Auto-generate preview
                setTimeout(() => {
                    generatePreview();
                }, 100);
            } else {
                statusDiv.textContent = 'Keine Event-Daten gefunden';
                statusDiv.style.color = '#ff9500';
            }

        } catch (error) {
            console.error('Error fetching URL:', error);
            
            // Fallback: Try alternative CORS proxy
            try {
                statusDiv.textContent = 'Verwende alternativen Proxy...';
                const fallbackProxyUrl = 'https://cors-anywhere.herokuapp.com/' + url;
                const fallbackResponse = await fetch(fallbackProxyUrl);
                
                if (!fallbackResponse.ok) {
                    throw new Error('Fallback failed');
                }

                const htmlContent = await fallbackResponse.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const eventInfo = extractEventInfo(doc);

                // Populate form fields
                let fieldsUpdated = 0;
                if (eventInfo.event) {
                    document.getElementById('event').value = eventInfo.event;
                    fieldsUpdated++;
                }
                if (eventInfo.venue) {
                    // Use venue name as location (preferred over address)
                    document.getElementById('location').value = eventInfo.venue;
                    fieldsUpdated++;
                } else if (eventInfo.location) {
                    document.getElementById('location').value = eventInfo.location;
                    fieldsUpdated++;
                }
                if (eventInfo.date) {
                    document.getElementById('date').value = eventInfo.date;
                    fieldsUpdated++;
                }
                if (eventInfo.endDate) {
                    document.getElementById('endDate').value = eventInfo.endDate;
                    fieldsUpdated++;
                }
                if (eventInfo.price) {
                    document.getElementById('price').value = eventInfo.price;
                    fieldsUpdated++;
                }

                if (fieldsUpdated > 0) {
                    statusDiv.textContent = `Event-Daten erfolgreich geladen (${fieldsUpdated} Felder aktualisiert)`;
                    statusDiv.style.color = '#4CAF50';
                    
                    setTimeout(() => {
                        generatePreview();
                    }, 100);
                } else {
                    statusDiv.textContent = 'Keine Event-Daten gefunden';
                    statusDiv.style.color = '#ff9500';
                }

            } catch (fallbackError) {
                statusDiv.textContent = 'Fehler beim Laden der URL. CORS-Proxy möglicherweise nicht verfügbar.';
                statusDiv.style.color = '#ff6b6b';
                
                // Show manual instruction
                setTimeout(() => {
                    statusDiv.innerHTML = 'Tipp: Öffne die RA-Seite, kopiere den HTML-Code (Strg+A, Strg+C) und füge ihn in das HTML Import Feld ein.';
                    statusDiv.style.color = '#888';
                }, 3000);
            }
        }
    }
</script>
</body>
</html>