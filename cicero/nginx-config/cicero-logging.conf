# Cicero Nginx Integration
# Add this to your nginx.conf in the http block

# Custom log format for Cicero
log_format cicero_format escape=json
  '{'
    '"timestamp":"$time_iso8601",'
    '"method":"$request_method",'
    '"url":"$uri",'
    '"query":"$args",'
    '"status":$status,'
    '"bytes":$body_bytes_sent,'
    '"response_time":$request_time,'
    '"ip":"$remote_addr",'
    '"real_ip":"$http_x_real_ip",'
    '"forwarded_for":"$http_x_forwarded_for",'
    '"user_agent":"$http_user_agent",'
    '"referer":"$http_referer",'
    '"host":"$host",'
    '"server_name":"$server_name"'
  '}';

# Log to separate file for Cicero processing
access_log /var/log/nginx/cicero.log cicero_format;

# Optional: Post-request hook (requires lua module)
# access_by_lua_block {
#   local http = require "resty.http"
#   local cjson = require "cjson"
#   
#   local httpc = http.new()
#   httpc:set_timeout(5000)
#   
#   local log_data = {
#     method = ngx.var.request_method,
#     url = ngx.var.uri,
#     status = ngx.status,
#     response_time = tonumber(ngx.var.request_time) * 1000,
#     timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ"),
#     headers = {
#       ["user-agent"] = ngx.var.http_user_agent,
#       ["referer"] = ngx.var.http_referer
#     },
#     query = {},
#     body = {},
#     user_agent = ngx.var.http_user_agent,
#     ip = ngx.var.remote_addr,
#     server = "mrx3k1-nginx",
#     content_length = tonumber(ngx.var.body_bytes_sent) or 0
#   }
#   
#   local res, err = httpc:request_uri("https://mrx3k1.de/cicero/api/log", {
#     method = "POST",
#     body = cjson.encode(log_data),
#     headers = {
#       ["Content-Type"] = "application/json"
#     }
#   })
# }