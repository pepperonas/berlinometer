<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KiezForm Eigentums√ºbertragung - Sichere Blockchain-basierte Zertifikat-√úbertragung">
    <title>Eigentums√ºbertragung - KiezForm</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JHCP2YWPX5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JHCP2YWPX5');
    </script>

    <!-- Open Graph -->
    <meta property="og:title" content="KiezForm Eigentums√ºbertragung">
    <meta property="og:description" content="Sichere Blockchain-basierte Zertifikat-√úbertragung">
    <meta property="og:image" content="https://kiezform.de/images/kiezform-transfer.jpg">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kiezform.de/transfer">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/legal.css">
</head>
<body>

<main class="container" style="padding-top: 2rem;">
    <div class="content">
        <h1>EIGENTUMS√úBERTRAGUNG</h1>
        
        <div id="transfer-content">
            <div class="loading-section">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Transfer-Informationen werden geladen...</p>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="container footer-content">
        <p>&copy; 2025 KIEZFORM. Alle Rechte vorbehalten.</p>
        <p>Blockchain Transfer - Made in Berlin</p>
    </div>
</footer>

<script>
// Transfer Page Logic
class TransferPage {
    constructor() {
        this.transferToken = this.getTransferTokenFromURL();
        this.init();
    }
    
    getTransferTokenFromURL() {
        const pathParts = window.location.pathname.split('/');
        return pathParts[pathParts.length - 1] || new URLSearchParams(window.location.search).get('token');
    }
    
    async init() {
        if (!this.transferToken) {
            this.showError('Kein Transfer-Token gefunden. Bitte verwende den korrekten QR-Code-Link.');
            return;
        }
        
        try {
            await this.loadTransferInfo();
        } catch (error) {
            console.error('Transfer initialization error:', error);
            this.showError('Fehler beim Laden der Transfer-Informationen.');
        }
    }
    
    async loadTransferInfo() {
        try {
            const response = await fetch(`/api/transfer/${this.transferToken}`);
            const data = await response.json();
            
            if (response.ok) {
                this.showTransferForm(data);
            } else {
                throw new Error(data.error || 'Transfer nicht gefunden');
            }
        } catch (error) {
            console.error('Transfer load error:', error);
            this.showError(error.message || 'Transfer nicht gefunden oder abgelaufen');
        }
    }
    
    showTransferForm(transferData) {
        const content = document.getElementById('transfer-content');
        content.innerHTML = `
            <div class="transfer-info">
                <h2>üîÑ EIGENTUMS√úBERTRAGUNG</h2>
                <p class="transfer-description">
                    Ein KiezForm-Schmuckst√ºck wird an dich √ºbertragen. Best√§tige die √úbertragung, 
                    um das digitale Eigentumszertifikat zu erhalten.
                </p>
                
                <div class="product-info">
                    <h3>PRODUKT-DETAILS</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Produktname:</span>
                            <span class="value">${transferData.productName}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Produkt-ID:</span>
                            <span class="value">${transferData.productId}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Aktueller Besitzer:</span>
                            <span class="value">${transferData.fromOwner}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">G√ºltig bis:</span>
                            <span class="value">${new Date(transferData.expiresAt).toLocaleString('de-DE')}</span>
                        </div>
                    </div>
                </div>
                
                <div class="transfer-form">
                    <h3>√úBERTRAGUNG BEST√ÑTIGEN</h3>
                    <p>Gib deinen Namen ein, um die Eigentums√ºbertragung abzuschlie√üen:</p>
                    
                    <div class="form-group">
                        <label for="owner-name">Dein Name (Optional):</label>
                        <input type="text" 
                               id="owner-name" 
                               placeholder="z.B. Max Mustermann" 
                               class="form-input">
                        <small class="form-note">
                            Dein Name wird nicht √∂ffentlich in der Blockchain gespeichert. 
                            Du erh√§ltst einen anonymen Eigent√ºmer-Code.
                        </small>
                    </div>
                    
                    <div class="form-actions">
                        <button id="confirm-transfer" class="confirm-btn">
                            üîê √úBERTRAGUNG BEST√ÑTIGEN
                        </button>
                        <button id="cancel-transfer" class="cancel-btn">
                            ‚ùå ABBRECHEN
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Add event listeners
        document.getElementById('confirm-transfer').addEventListener('click', () => {
            this.confirmTransfer();
        });
        
        document.getElementById('cancel-transfer').addEventListener('click', () => {
            window.close() || history.back();
        });
        
        // Add styles
        this.addTransferStyles();
    }
    
    async confirmTransfer() {
        const nameInput = document.getElementById('owner-name');
        const newOwnerName = nameInput?.value.trim() || 'Anonym';
        
        try {
            const confirmBtn = document.getElementById('confirm-transfer');
            confirmBtn.disabled = true;
            confirmBtn.textContent = '√úbertragung l√§uft...';
            
            const response = await fetch('/api/transfer/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transferToken: this.transferToken,
                    newOwnerName: newOwnerName
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.showSuccess(data);
            } else {
                throw new Error(data.error || 'Transfer fehlgeschlagen');
            }
        } catch (error) {
            console.error('Transfer confirmation error:', error);
            this.showError(error.message || 'Fehler bei der √úbertragung');
            
            // Re-enable button
            const confirmBtn = document.getElementById('confirm-transfer');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'üîê √úBERTRAGUNG BEST√ÑTIGEN';
        }
    }
    
    showSuccess(data) {
        const content = document.getElementById('transfer-content');
        content.innerHTML = `
            <div class="success-message">
                <h2>‚úÖ √úBERTRAGUNG ERFOLGREICH</h2>
                <p class="success-description">
                    Das Eigentumszertifikat wurde erfolgreich √ºbertragen!
                </p>
                
                <div class="success-details">
                    <div class="detail-item">
                        <span class="label">Dein neuer Eigent√ºmer-Code:</span>
                        <span class="value owner-code">${data.newOwner}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Blockchain-Block:</span>
                        <span class="value">${data.blockId}</span>
                    </div>
                </div>
                
                <div class="next-steps">
                    <h3>N√ÑCHSTE SCHRITTE</h3>
                    <ul>
                        <li>Notiere dir deinen Eigent√ºmer-Code: <strong>${data.newOwner}</strong></li>
                        <li>Verwende diesen Code, um dein Zertifikat in der <a href="/blockchain">Blockchain</a> zu finden</li>
                        <li>Der Transfer ist permanent und kann nicht r√ºckg√§ngig gemacht werden</li>
                    </ul>
                </div>
                
                <div class="action-buttons">
                    <a href="/blockchain" class="blockchain-btn">
                        üîó BLOCKCHAIN EXPLORER
                    </a>
                    <a href="/" class="home-btn">
                        üè† ZUR√úCK ZUR STARTSEITE
                    </a>
                </div>
            </div>
        `;
        
        this.addSuccessStyles();
    }
    
    showError(message) {
        const content = document.getElementById('transfer-content');
        content.innerHTML = `
            <div class="error-message">
                <h2>‚ö†Ô∏è FEHLER</h2>
                <p class="error-description">${message}</p>
                
                <div class="error-actions">
                    <button onclick="window.location.reload()" class="retry-btn">
                        üîÑ ERNEUT VERSUCHEN
                    </button>
                    <a href="/" class="home-btn">
                        üè† ZUR√úCK ZUR STARTSEITE
                    </a>
                </div>
            </div>
        `;
        
        this.addErrorStyles();
    }
    
    addTransferStyles() {
        if (document.getElementById('transfer-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'transfer-styles';
        style.textContent = `
            .transfer-info h2 {
                color: #00ff00;
                text-align: center;
                margin-bottom: 2rem;
                font-size: 1.5rem;
                font-weight: 300;
                letter-spacing: 0.2em;
            }
            
            .transfer-description {
                text-align: center;
                margin-bottom: 3rem;
                color: #808080;
                line-height: 1.6;
            }
            
            .product-info, .transfer-form {
                margin-bottom: 3rem;
                padding: 2rem;
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            .product-info h3, .transfer-form h3 {
                margin-bottom: 1.5rem;
                color: #fff;
                font-size: 1rem;
                letter-spacing: 0.1em;
            }
            
            .info-grid {
                display: grid;
                gap: 1rem;
            }
            
            .info-item {
                display: grid;
                grid-template-columns: 150px 1fr;
                gap: 1rem;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            .info-item .label {
                color: #606060;
                font-size: 0.9rem;
            }
            
            .info-item .value {
                color: #fff;
                font-family: monospace;
            }
            
            .form-group {
                margin-bottom: 2rem;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                color: #a0a0a0;
                font-size: 0.9rem;
                letter-spacing: 0.05em;
            }
            
            .form-input {
                width: 100%;
                background: #000;
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #fff;
                padding: 1rem;
                font-size: 0.9rem;
                transition: all 0.3s;
                outline: none;
            }
            
            .form-input:focus {
                border-color: rgba(0, 255, 0, 0.5);
            }
            
            .form-note {
                display: block;
                margin-top: 0.5rem;
                color: #606060;
                font-size: 0.8rem;
                line-height: 1.4;
            }
            
            .form-actions {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 1rem;
                align-items: center;
            }
            
            .confirm-btn, .cancel-btn {
                padding: 1rem 2rem;
                border: 1px solid;
                background: transparent;
                cursor: pointer;
                transition: all 0.3s;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-size: 0.9rem;
            }
            
            .confirm-btn {
                border-color: #00ff00;
                color: #00ff00;
            }
            
            .confirm-btn:hover:not(:disabled) {
                background: rgba(0, 255, 0, 0.1);
            }
            
            .confirm-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .cancel-btn {
                border-color: #666;
                color: #666;
            }
            
            .cancel-btn:hover {
                border-color: #fff;
                color: #fff;
            }
            
            @media (max-width: 768px) {
                .info-item {
                    grid-template-columns: 1fr;
                    gap: 0.5rem;
                }
                
                .form-actions {
                    grid-template-columns: 1fr;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    addSuccessStyles() {
        if (document.getElementById('success-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'success-styles';
        style.textContent = `
            .success-message {
                text-align: center;
            }
            
            .success-message h2 {
                color: #00ff00;
                margin-bottom: 2rem;
                font-size: 1.5rem;
                font-weight: 300;
                letter-spacing: 0.2em;
            }
            
            .success-description {
                color: #808080;
                margin-bottom: 3rem;
                font-size: 1.1rem;
                line-height: 1.6;
            }
            
            .success-details {
                background: rgba(0, 255, 0, 0.05);
                border: 1px solid rgba(0, 255, 0, 0.2);
                padding: 2rem;
                margin-bottom: 3rem;
                text-align: left;
            }
            
            .success-details .detail-item {
                display: grid;
                grid-template-columns: 200px 1fr;
                gap: 1rem;
                margin-bottom: 1rem;
                align-items: center;
            }
            
            .success-details .label {
                color: #a0a0a0;
                font-size: 0.9rem;
            }
            
            .success-details .value {
                color: #fff;
                font-family: monospace;
            }
            
            .owner-code {
                color: #00ff00 !important;
                font-weight: 500;
                font-size: 1.1rem;
            }
            
            .next-steps {
                background: rgba(255, 255, 255, 0.02);
                border: 1px solid rgba(255, 255, 255, 0.05);
                padding: 2rem;
                margin-bottom: 3rem;
                text-align: left;
            }
            
            .next-steps h3 {
                color: #fff;
                margin-bottom: 1rem;
                font-size: 1rem;
                letter-spacing: 0.1em;
            }
            
            .next-steps ul {
                color: #808080;
                line-height: 1.6;
            }
            
            .next-steps li {
                margin-bottom: 0.8rem;
            }
            
            .next-steps strong {
                color: #00ff00;
                font-family: monospace;
            }
            
            .next-steps a {
                color: #0088ff;
                text-decoration: none;
            }
            
            .next-steps a:hover {
                color: #00aaff;
            }
            
            .action-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-top: 2rem;
            }
            
            .blockchain-btn, .home-btn {
                display: inline-block;
                padding: 1rem 2rem;
                border: 1px solid;
                background: transparent;
                text-decoration: none;
                text-align: center;
                transition: all 0.3s;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-size: 0.9rem;
            }
            
            .blockchain-btn {
                border-color: #0088ff;
                color: #0088ff;
            }
            
            .blockchain-btn:hover {
                background: rgba(0, 136, 255, 0.1);
            }
            
            .home-btn {
                border-color: #666;
                color: #666;
            }
            
            .home-btn:hover {
                border-color: #fff;
                color: #fff;
            }
        `;
        document.head.appendChild(style);
    }
    
    addErrorStyles() {
        if (document.getElementById('error-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'error-styles';
        style.textContent = `
            .error-message {
                text-align: center;
            }
            
            .error-message h2 {
                color: #ff4444;
                margin-bottom: 2rem;
                font-size: 1.5rem;
                font-weight: 300;
                letter-spacing: 0.2em;
            }
            
            .error-description {
                color: #808080;
                margin-bottom: 3rem;
                font-size: 1.1rem;
                line-height: 1.6;
            }
            
            .error-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .retry-btn {
                padding: 1rem 2rem;
                border: 1px solid #ff4444;
                background: transparent;
                color: #ff4444;
                cursor: pointer;
                transition: all 0.3s;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-size: 0.9rem;
            }
            
            .retry-btn:hover {
                background: rgba(255, 68, 68, 0.1);
            }
        `;
        document.head.appendChild(style);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    new TransferPage();
});
</script>

</body>
</html>