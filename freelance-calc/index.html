<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freiberufler Netto-Rechner</title>

    <meta property="og:title" content="Freelance Rechner">
    <meta property="og:description"
          content="Berechne dein Nettoeinkommen als Freiberufler ‚Äì einfach Umsatz und Ausgaben eingeben, Steuern und Abgaben checken!">
    <meta property="og:image" content="freelance.jpg">
    <meta property="og:type" content="website">

    <style>
        :root {
            --primary-color: #2C2E3B;
            --primary-light: #383B4F;
            --text-color: #ffffff;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --blue-300: #93c5fd;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --gray-600: #4b5563;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            touch-action: manipulation;
        }

        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 16px 16px 64px;
            min-height: 100vh;
            transition: colors 300ms;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        .calculator {
            background-color: var(--primary-light);
            padding: 2rem;
            border-radius: 12px;
            max-width: 1024px;
            width: 100%;
            margin: 0 auto;
            box-shadow: var(--shadow);
            animation: slideIn 0.4s ease-out;
        }

        h1 {
            text-align: center;
            color: var(--blue-300);
            margin-bottom: 1.5rem;
            font-weight: bold;
            font-size: 2rem;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background-color: var(--primary-color);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .tab {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s;
            flex: 1;
        }

        .tab.active {
            background-color: var(--blue-600);
            color: white;
            font-weight: 600;
        }

        .tab:hover:not(.active) {
            background-color: var(--gray-600);
            transform: scale(1.02);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-600);
            border-radius: 8px;
            background-color: var(--primary-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--blue-600);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        button {
            width: 100%;
            padding: 12px 24px;
            background-color: var(--blue-600);
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 16px;
        }

        button:hover {
            background-color: var(--blue-700);
            transform: scale(1.02);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .result {
            margin-top: 2rem;
            background-color: var(--primary-color);
            padding: 1.5rem;
            border-radius: 12px;
            display: none;
            animation: slideIn 0.4s ease-out;
            box-shadow: var(--shadow);
        }

        /* PWA Animationen und Transitions */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes chartLoad {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .result h2 {
            color: var(--blue-300);
            margin-bottom: 1.2rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .result p {
            margin-bottom: 0.7rem;
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-600);
            transition: background-color 0.2s;
        }

        .result p:last-child {
            border-bottom: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--blue-600);
        }

        .highlight {
            color: var(--blue-300);
            font-weight: 600;
        }

        .section-divider {
            margin: 2rem 0;
            text-align: center;
            position: relative;
        }

        .section-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: var(--gray-600);
        }

        .section-divider span {
            position: relative;
            background-color: var(--primary-light);
            padding: 0 1rem;
            color: var(--blue-300);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Besseres Touch-Feedback f√ºr mobile Ger√§te */
        button, a {
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (max-width: 640px) {
            /* Optimierung f√ºr kleine Bildschirme */
            input, button {
                font-size: 16px; /* Verhindert Zoom auf iOS bei Focus */
            }
        }
        
        @media (max-width: 480px) {
            .calculator {
                padding: 1.5rem;
                border-radius: 12px;
            }

            h1 {
                font-size: 1.5rem;
            }

            button {
                font-size: 1rem;
            }
        }
        
        /* Footer */
        .footer {
            margin-top: 32px;
            padding-top: 16px;
            padding-bottom: 8px;
            text-align: center;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
<div class="calculator">
    <h1>üí∞ Freiberufler Netto-Rechner (2025)</h1>

    <div class="tabs">
        <button class="tab active" data-tab="yearly">Jahresumsatz</button>
        <button class="tab" data-tab="hourly">Stundensatz</button>
    </div>

    <div id="yearly-tab" class="tab-content active">
        <form id="yearly-form">
            <div class="form-group">
                <label for="income">J√§hrlicher Umsatz (‚Ç¨):</label>
                <input type="number" id="income" value="80000" min="0" step="1000" required>
            </div>
            <div class="form-group">
                <label for="expenses">Betriebsausgaben (‚Ç¨):</label>
                <input type="number" id="expenses" value="10000" min="0" step="1000" required>
            </div>
            <div class="form-group">
                <label for="insurance">Krankenversicherung:</label>
                <select id="insurance" required>
                    <option value="gkv">Gesetzliche Krankenversicherung (GKV)</option>
                    <option value="pkv">Private Krankenversicherung (PKV)</option>
                </select>
            </div>
            <div class="form-group pkv-cost-group" style="display: none;">
                <label for="pkv-cost">Monatliche PKV-Kosten (‚Ç¨):</label>
                <input type="number" id="pkv-cost" value="500" min="0" step="50">
            </div>
            <button type="submit">Berechnen</button>
        </form>
    </div>

    <div id="hourly-tab" class="tab-content">
        <form id="hourly-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="hourly-rate">Stundensatz (‚Ç¨):</label>
                    <input type="number" id="hourly-rate" value="80" min="0" step="5" required>
                </div>
                <div class="form-group">
                    <label for="daily-hours">Arbeitsstunden pro Tag:</label>
                    <input type="number" id="daily-hours" value="6" min="0.5" max="24" step="0.5" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="weekly-days">Arbeitstage pro Woche:</label>
                    <input type="number" id="weekly-days" value="5" min="0.5" max="7" step="0.5" required>
                </div>
                <div class="form-group">
                    <label for="vacation-days">Urlaubstage pro Jahr:</label>
                    <input type="number" id="vacation-days" value="25" min="0" max="365" step="1" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="sick-days">Krankheitstage pro Jahr:</label>
                    <input type="number" id="sick-days" value="5" min="0" max="365" step="1" required>
                </div>
                <div class="form-group">
                    <label for="utilization">Auslastung (%):</label>
                    <input type="number" id="utilization" value="80" min="1" max="100" step="1" required>
                </div>
            </div>
            <div class="form-group">
                <label for="hourly-expenses">Betriebsausgaben (‚Ç¨):</label>
                <input type="number" id="hourly-expenses" value="10000" min="0" step="1000" required>
            </div>
            <div class="form-group">
                <label for="hourly-insurance">Krankenversicherung:</label>
                <select id="hourly-insurance" required>
                    <option value="gkv">Gesetzliche Krankenversicherung (GKV)</option>
                    <option value="pkv">Private Krankenversicherung (PKV)</option>
                </select>
            </div>
            <div class="form-group pkv-cost-group" style="display: none;">
                <label for="hourly-pkv-cost">Monatliche PKV-Kosten (‚Ç¨):</label>
                <input type="number" id="hourly-pkv-cost" value="500" min="0" step="50">
            </div>
            <button type="submit">Berechnen</button>
        </form>

        <div class="section-divider">
            <span>oder</span>
        </div>

        <form id="target-income-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="target-income">Gew√ºnschtes Netto-Jahreseinkommen (‚Ç¨):</label>
                    <input type="number" id="target-income" value="50000" min="0" step="1000" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="target-daily-hours">Arbeitsstunden pro Tag:</label>
                    <input type="number" id="target-daily-hours" value="6" min="0.5" max="24" step="0.5" required>
                </div>
                <div class="form-group">
                    <label for="target-weekly-days">Arbeitstage pro Woche:</label>
                    <input type="number" id="target-weekly-days" value="5" min="0.5" max="7" step="0.5" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="target-vacation-days">Urlaubstage pro Jahr:</label>
                    <input type="number" id="target-vacation-days" value="25" min="0" max="365" step="1" required>
                </div>
                <div class="form-group">
                    <label for="target-sick-days">Krankheitstage pro Jahr:</label>
                    <input type="number" id="target-sick-days" value="5" min="0" max="365" step="1" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="target-utilization">Auslastung (%):</label>
                    <input type="number" id="target-utilization" value="80" min="1" max="100" step="1" required>
                </div>
                <div class="form-group">
                    <label for="target-expenses">Betriebsausgaben (‚Ç¨):</label>
                    <input type="number" id="target-expenses" value="10000" min="0" step="1000" required>
                </div>
            </div>
            <div class="form-group">
                <label for="target-insurance">Krankenversicherung:</label>
                <select id="target-insurance" required>
                    <option value="gkv">Gesetzliche Krankenversicherung (GKV)</option>
                    <option value="pkv">Private Krankenversicherung (PKV)</option>
                </select>
            </div>
            <div class="form-group pkv-cost-group" style="display: none;">
                <label for="target-pkv-cost">Monatliche PKV-Kosten (‚Ç¨):</label>
                <input type="number" id="target-pkv-cost" value="500" min="0" step="50">
            </div>
            <button type="submit">Stundensatz berechnen</button>
        </form>
    </div>

    <div class="result" id="result">
        <h2>Dein Nettoeinkommen</h2>
        <p><span>Gewinn:</span> <span id="profit" class="highlight"></span></p>
        <p><span>Einkommensteuer:</span> <span id="tax" class="highlight"></span></p>
        <p><span>Sozialabgaben:</span> <span id="social" class="highlight"></span></p>
        <p><span>Nettoeinkommen (j√§hrlich):</span> <span id="net-yearly" class="highlight"></span></p>
        <p><span>Nettoeinkommen (monatlich):</span> <span id="net-monthly" class="highlight"></span></p>
        <div id="hourly-result" style="display: none;">
            <p><span>Fakturierbare Stunden pro Jahr:</span> <span id="billable-hours" class="highlight"></span></p>
            <p><span>Umsatz (j√§hrlich):</span> <span id="calculated-income" class="highlight"></span></p>
        </div>
        <div id="target-result" style="display: none;">
            <p><span>Ben√∂tigter Stundensatz:</span> <span id="required-rate" class="highlight"></span></p>
            <p><span>Fakturierbare Stunden pro Jahr:</span> <span id="target-billable-hours" class="highlight"></span></p>
            <p><span>Umsatz (j√§hrlich):</span> <span id="target-calculated-income" class="highlight"></span></p>
        </div>
    </div>
    
    <!-- Footer - matching weather app -->
    <div class="footer">
        Made with ‚ù§Ô∏è by Martin Pfeffer
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Debug-Logging f√ºr Diagnose
        window.logDebugInfo = function(message) {
            if (window.localStorage.getItem('debug') === 'true') {
                console.log('[DEBUG]', message);
            }
        };

        // Debug-Mode aktivieren mit localStorage.setItem('debug', 'true')

        // Fehlermeldung anzeigen mit mehr Details
        function showError(message, details = '') {
            alert(message);
            window.logDebugInfo('Fehler: ' + message + (details ? '\nDetails: ' + details : ''));
        }

        // Tab-Funktionalit√§t
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');

                // Aktive Tab-Klasse aktualisieren
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Tab-Inhalte anzeigen/ausblenden
                tabContents.forEach(content => {
                    if (content.id === `${targetTab}-tab`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });

                // Ergebnisbereich ausblenden
                const resultElement = document.getElementById('result');
                if (resultElement) {
                    resultElement.style.display = 'none';
                }
            });
        });

        // PKV-Kosten-Felder ein-/ausblenden
        const insuranceSelects = document.querySelectorAll('#insurance, #hourly-insurance, #target-insurance');

        insuranceSelects.forEach(select => {
            // Initial pr√ºfen und entsprechend anzeigen
            const formId = select.id;
            let pkvGroup;

            if (formId === 'insurance') {
                pkvGroup = document.querySelector('#yearly-form .pkv-cost-group');
            } else if (formId === 'hourly-insurance') {
                pkvGroup = document.querySelector('#hourly-form .pkv-cost-group');
            } else if (formId === 'target-insurance') {
                pkvGroup = document.querySelector('#target-income-form .pkv-cost-group');
            }

            if (pkvGroup) {
                pkvGroup.style.display = select.value === 'pkv' ? 'block' : 'none';
            }

            // Event-Listener f√ºr zuk√ºnftige √Ñnderungen
            select.addEventListener('change', function() {
                const formId = this.id;
                let pkvGroup;

                if (formId === 'insurance') {
                    pkvGroup = document.querySelector('#yearly-form .pkv-cost-group');
                } else if (formId === 'hourly-insurance') {
                    pkvGroup = document.querySelector('#hourly-form .pkv-cost-group');
                } else if (formId === 'target-insurance') {
                    pkvGroup = document.querySelector('#target-income-form .pkv-cost-group');
                }

                if (pkvGroup) {
                    pkvGroup.style.display = this.value === 'pkv' ? 'block' : 'none';
                }
            });
        });

        // Formular-Validierung
        function validateForm(formValues) {
            // Pr√ºfen, ob alle Werte numerisch und definiert sind
            for (const key in formValues) {
                // Insurance ist ein String und wird separat gepr√ºft
                if (key === 'insurance') continue;

                // PKV-Kosten k√∂nnen 0 sein, wenn "gkv" ausgew√§hlt ist
                if (key === 'pkvCost' && formValues.insurance === 'gkv') continue;

                if (isNaN(formValues[key])) {
                    console.log('Ung√ºltiger Wert f√ºr', key, formValues[key]);
                    return { valid: false, message: 'Bitte f√ºlle alle Felder korrekt aus.' };
                }
            }

            // Pr√ºfen ob insurance ein g√ºltiger Wert ist
            if (formValues.insurance !== 'gkv' && formValues.insurance !== 'pkv') {
                console.log('Ung√ºltiger Wert f√ºr insurance:', formValues.insurance);
                return { valid: false, message: 'Bitte w√§hle eine g√ºltige Krankenversicherung aus.' };
            }

            // Spezielle Validierung f√ºr PKV-Kosten
            if (formValues.insurance === 'pkv' && (isNaN(formValues.pkvCost) || formValues.pkvCost <= 0)) {
                return { valid: false, message: 'Bitte gib einen g√ºltigen Wert f√ºr die PKV-Kosten ein.' };
            }

            if (formValues.hasOwnProperty('expenses') && formValues.hasOwnProperty('income')) {
                if (formValues.expenses > formValues.income) {
                    return { valid: false, message: 'Betriebsausgaben d√ºrfen den Umsatz nicht √ºbersteigen.' };
                }
            }

            if (formValues.hasOwnProperty('weeklyDays') && (formValues.weeklyDays < 0.5 || formValues.weeklyDays > 7)) {
                return { valid: false, message: 'Arbeitstage pro Woche m√ºssen zwischen 0.5 und 7 liegen.' };
            }

            if (formValues.hasOwnProperty('dailyHours') && (formValues.dailyHours < 0.5 || formValues.dailyHours > 24)) {
                return { valid: false, message: 'Arbeitsstunden pro Tag m√ºssen zwischen 0.5 und 24 liegen.' };
            }

            if (formValues.hasOwnProperty('utilization') && (formValues.utilization < 1 || formValues.utilization > 100)) {
                return { valid: false, message: 'Auslastung muss zwischen 1% und 100% liegen.' };
            }

            return { valid: true };
        }

        // Berechnung der Einkommensteuer
        function calculateTax(taxableIncome) {
            const grundfreibetrag = 12084;
            let tax = 0;

            if (taxableIncome > grundfreibetrag) {
                if (taxableIncome <= 22960) {
                    tax = (taxableIncome - grundfreibetrag) * 0.14;
                } else if (taxableIncome <= 62530) {
                    tax = (22960 - grundfreibetrag) * 0.14 + (taxableIncome - 22960) * 0.30;
                } else {
                    tax = (22960 - grundfreibetrag) * 0.14 + (62530 - 22960) * 0.30 + (taxableIncome - 62530) * 0.42;
                }
            }

            return Math.round(tax);
        }

        // Berechnung der Sozialabgaben
        function calculateSocialContributions(profit, insurance, pkvCost) {
            let socialContributions = 0;
            const maxBeitragsbemessung = 64350;

            if (insurance === 'gkv') {
                // GKV: 14.6% KV + 3.4% PV (kinderlos) + 1% Zusatzbeitrag
                const gkvRate = 0.146 + 0.034 + 0.01;
                const gkvBase = Math.min(profit, maxBeitragsbemessung);
                socialContributions += gkvBase * gkvRate;
                // Rentenversicherung: 18.6%
                socialContributions += gkvBase * 0.186;
            } else {
                // PKV: Fixe Kosten
                socialContributions += pkvCost;
                // Rentenversicherung: 18.6%
                const rvBase = Math.min(profit, maxBeitragsbemessung);
                socialContributions += rvBase * 0.186;
            }

            return Math.round(socialContributions);
        }

        // Berechnung des Nettoeinkommens
        function calculateNetIncome(profit, tax, socialContributions) {
            return profit - tax - socialContributions;
        }

        // Berechnung der faktorierbaren Stunden
        function calculateBillableHours(dailyHours, weeklyDays, vacationDays, sickDays, utilization) {
            // Pr√ºfen auf g√ºltige Werte und sicherstellen, dass keine Berechnung mit 0 erfolgt
            if (dailyHours <= 0 || weeklyDays <= 0 || utilization <= 0) {
                return 0;
            }

            // Anzahl der Arbeitstage pro Jahr (ohne Wochenenden)
            const workingDaysPerYear = weeklyDays * 52;

            // Abz√ºglich Urlaubs- und Krankheitstage
            // Sicherstellen, dass keine negativen Werte verwendet werden
            const actualWorkingDays = Math.max(0, workingDaysPerYear - vacationDays - sickDays);

            // Gesamtstunden pro Jahr
            const totalHoursPerYear = actualWorkingDays * dailyHours;

            // Fakturierbare Stunden (basierend auf Auslastung)
            return totalHoursPerYear * (utilization / 100);
        }

        // Anzeigen der Ergebnisse
        function displayResults(results, hourlyData = null, targetData = null) {
            document.getElementById('profit').textContent = `${results.profit.toLocaleString('de-DE')} ‚Ç¨`;
            document.getElementById('tax').textContent = `${results.tax.toLocaleString('de-DE')} ‚Ç¨`;
            document.getElementById('social').textContent = `${results.socialContributions.toLocaleString('de-DE')} ‚Ç¨`;
            document.getElementById('net-yearly').textContent = `${results.netYearly.toLocaleString('de-DE')} ‚Ç¨`;
            document.getElementById('net-monthly').textContent = `${results.netMonthly.toFixed(2).replace('.', ',')} ‚Ç¨`;

            // Hourly-spezifische Ergebnisse
            const hourlyResultSection = document.getElementById('hourly-result');
            if (hourlyData) {
                document.getElementById('billable-hours').textContent = `${hourlyData.billableHours.toFixed(1)} Stunden`;
                document.getElementById('calculated-income').textContent = `${hourlyData.income.toLocaleString('de-DE')} ‚Ç¨`;
                hourlyResultSection.style.display = 'block';
            } else {
                hourlyResultSection.style.display = 'none';
            }

            // Target-spezifische Ergebnisse
            const targetResultSection = document.getElementById('target-result');
            if (targetData) {
                document.getElementById('required-rate').textContent = `${targetData.requiredRate.toFixed(2).replace('.', ',')} ‚Ç¨`;
                document.getElementById('target-billable-hours').textContent = `${targetData.billableHours.toFixed(1)} Stunden`;
                document.getElementById('target-calculated-income').textContent = `${targetData.income.toLocaleString('de-DE')} ‚Ç¨`;
                targetResultSection.style.display = 'block';
            } else {
                targetResultSection.style.display = 'none';
            }

            // Ergebnisbereich anzeigen
            document.getElementById('result').style.display = 'block';
        }

        // Jahresformular verarbeiten
        function processYearlyForm() {
            // Eingaben holen
            const formValues = {
                income: parseFloat(document.getElementById('income').value),
                expenses: parseFloat(document.getElementById('expenses').value),
                insurance: document.getElementById('insurance').value,
                pkvCost: 0
            };

            // Pr√ºfen, ob g√ºltige Versicherungsoption gew√§hlt wurde
            if (formValues.insurance !== 'gkv' && formValues.insurance !== 'pkv') {
                alert('Bitte w√§hle eine g√ºltige Krankenversicherung aus.');
                return;
            }

            // PKV-Kosten nur hinzuf√ºgen, wenn PKV ausgew√§hlt ist
            if (formValues.insurance === 'pkv') {
                formValues.pkvCost = parseFloat(document.getElementById('pkv-cost').value) * 12;
            }

            // Validierung
            const validation = validateForm(formValues);
            if (!validation.valid) {
                showError(validation.message, JSON.stringify(formValues));
                return;
            }

            // Berechnungen
            const profit = formValues.income - formValues.expenses;
            const tax = calculateTax(profit);
            const socialContributions = calculateSocialContributions(profit, formValues.insurance, formValues.pkvCost);
            const netYearly = calculateNetIncome(profit, tax, socialContributions);
            const netMonthly = netYearly / 12;

            // Ergebnisse anzeigen
            displayResults({
                profit,
                tax,
                socialContributions,
                netYearly,
                netMonthly
            });
        }

        // Stundensatz-Formular verarbeiten
        function processHourlyForm() {
            // Eingaben holen
            const formValues = {
                hourlyRate: parseFloat(document.getElementById('hourly-rate').value),
                dailyHours: parseFloat(document.getElementById('daily-hours').value),
                weeklyDays: parseFloat(document.getElementById('weekly-days').value),
                vacationDays: parseFloat(document.getElementById('vacation-days').value),
                sickDays: parseFloat(document.getElementById('sick-days').value),
                utilization: parseFloat(document.getElementById('utilization').value),
                expenses: parseFloat(document.getElementById('hourly-expenses').value),
                insurance: document.getElementById('hourly-insurance').value,
                pkvCost: 0
            };

            // Pr√ºfen, ob g√ºltige Versicherungsoption gew√§hlt wurde
            if (formValues.insurance !== 'gkv' && formValues.insurance !== 'pkv') {
                alert('Bitte w√§hle eine g√ºltige Krankenversicherung aus.');
                return;
            }

            // PKV-Kosten nur hinzuf√ºgen, wenn PKV ausgew√§hlt ist
            if (formValues.insurance === 'pkv') {
                formValues.pkvCost = parseFloat(document.getElementById('hourly-pkv-cost').value) * 12;
            }

            // Validierung
            const validation = validateForm(formValues);
            if (!validation.valid) {
                showError(validation.message, JSON.stringify(formValues));
                return;
            }

            // Fakturierbare Stunden berechnen
            const billableHours = calculateBillableHours(
                formValues.dailyHours,
                formValues.weeklyDays,
                formValues.vacationDays,
                formValues.sickDays,
                formValues.utilization
            );

            // Pr√ºfen, ob billableHours g√ºltig ist
            if (billableHours <= 0) {
                showError('Die berechneten fakturierbaren Stunden sind ung√ºltig. Bitte √ºberpr√ºfe deine Eingaben zu Arbeitszeiten und Auslastung.',
                    `billableHours: ${billableHours}, dailyHours: ${formValues.dailyHours}, weeklyDays: ${formValues.weeklyDays}, utilization: ${formValues.utilization}`);
                return;
            }

            // Jahresumsatz berechnen
            const income = billableHours * formValues.hourlyRate;

            // Weitere Berechnungen
            const profit = income - formValues.expenses;
            const tax = calculateTax(profit);
            const socialContributions = calculateSocialContributions(profit, formValues.insurance, formValues.pkvCost);
            const netYearly = calculateNetIncome(profit, tax, socialContributions);
            const netMonthly = netYearly / 12;

            // Ergebnisse anzeigen
            displayResults({
                profit,
                tax,
                socialContributions,
                netYearly,
                netMonthly
            }, {
                billableHours,
                income
            });
        }

        // Ziel-Einkommen-Formular verarbeiten
        function processTargetForm() {
            // Eingaben holen
            const formValues = {
                targetIncome: parseFloat(document.getElementById('target-income').value),
                dailyHours: parseFloat(document.getElementById('target-daily-hours').value),
                weeklyDays: parseFloat(document.getElementById('target-weekly-days').value),
                vacationDays: parseFloat(document.getElementById('target-vacation-days').value),
                sickDays: parseFloat(document.getElementById('target-sick-days').value),
                utilization: parseFloat(document.getElementById('target-utilization').value),
                expenses: parseFloat(document.getElementById('target-expenses').value),
                insurance: document.getElementById('target-insurance').value,
                pkvCost: 0
            };

            // Pr√ºfen, ob g√ºltige Versicherungsoption gew√§hlt wurde
            if (formValues.insurance !== 'gkv' && formValues.insurance !== 'pkv') {
                alert('Bitte w√§hle eine g√ºltige Krankenversicherung aus.');
                return;
            }

            // PKV-Kosten nur hinzuf√ºgen, wenn PKV ausgew√§hlt ist
            if (formValues.insurance === 'pkv') {
                formValues.pkvCost = parseFloat(document.getElementById('target-pkv-cost').value) * 12;
            }

            // Validierung
            const validation = validateForm(formValues);
            if (!validation.valid) {
                showError(validation.message, JSON.stringify(formValues));
                return;
            }

            // Fakturierbare Stunden berechnen
            const billableHours = calculateBillableHours(
                formValues.dailyHours,
                formValues.weeklyDays,
                formValues.vacationDays,
                formValues.sickDays,
                formValues.utilization
            );

            // Pr√ºfen, ob billableHours g√ºltig ist
            if (billableHours <= 0) {
                showError('Die berechneten fakturierbaren Stunden sind ung√ºltig. Bitte √ºberpr√ºfe deine Eingaben zu Arbeitszeiten und Auslastung.',
                    `billableHours: ${billableHours}, dailyHours: ${formValues.dailyHours}, weeklyDays: ${formValues.weeklyDays}, utilization: ${formValues.utilization}`);
                return;
            }

            // Ben√∂tigten Stundensatz berechnen durch Iteration
            let requiredRate = 10; // Startpunkt f√ºr die Iteration
            let netYearly = 0;
            let income = 0;
            let profit = 0;
            let tax = 0;
            let socialContributions = 0;

            // Iteratives Ann√§hern an den Zielwert
            const step = 0.5;
            const maxIterations = 1000;
            let iterations = 0;

            // Sicherstellen, dass das Zieleinkommen positiv ist
            const targetIncome = Math.max(1, formValues.targetIncome);

            while (netYearly < targetIncome && iterations < maxIterations) {
                requiredRate += step;
                iterations++;

                income = billableHours * requiredRate;
                profit = income - formValues.expenses;
                tax = calculateTax(profit);
                socialContributions = calculateSocialContributions(profit, formValues.insurance, formValues.pkvCost);
                netYearly = calculateNetIncome(profit, tax, socialContributions);
            }

            // √úberpr√ºfen, ob die Berechnung erfolgreich war
            if (iterations >= maxIterations) {
                showError('Der ben√∂tigte Stundensatz ist zu hoch f√ºr eine genaue Berechnung. Bitte √ºberpr√ºfe deine Eingabeparameter.',
                    `targetIncome: ${targetIncome}, billableHours: ${billableHours}, maxRate: ${requiredRate}`);
                return;
            }

            const netMonthly = netYearly / 12;

            // Ergebnisse anzeigen
            displayResults({
                profit,
                tax,
                socialContributions,
                netYearly,
                netMonthly
            }, null, {
                requiredRate,
                billableHours,
                income
            });
        }

        // Formular-Event-Listener
        const yearlyForm = document.getElementById('yearly-form');
        if (yearlyForm) {
            yearlyForm.addEventListener('submit', function(e) {
                e.preventDefault();
                processYearlyForm();
            });
        }

        const hourlyForm = document.getElementById('hourly-form');
        if (hourlyForm) {
            hourlyForm.addEventListener('submit', function(e) {
                e.preventDefault();
                processHourlyForm();
            });
        }

        const targetForm = document.getElementById('target-income-form');
        if (targetForm) {
            targetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                processTargetForm();
            });
        }
    });
</script>
</body>
</html>