# /etc/nginx/sites-available/default

# HTTP-Server für hue.mrx3k1.de (muss vor der HTTPS-Weiterleitung sein)
server {
    listen 80;
    listen [::]:80;
    
    server_name hue.mrx3k1.de;
    
    # Root-Verzeichnis für die GlitterHue App
    root /var/www/html/glitter-hue/build;
    index index.html;
    
    # CORS-Header für die Kommunikation mit der Hue Bridge
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
    
    # Hauptroute für die React-App
    location / {
        try_files $uri $uri/ /index.html;
        
        # Verhindert Caching von index.html um App-Updates sofort zu sehen
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # Proxy für die Hue API
    location /hue/ {
        proxy_pass http://localhost:8081/hue/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Debug-Logging
        access_log /var/log/nginx/glitterhue-proxy-access.log;
        error_log /var/log/nginx/glitterhue-proxy-error.log debug;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Logs
    access_log /var/log/nginx/hue.mrx3k1.de-access.log;
    error_log /var/log/nginx/hue.mrx3k1.de-error.log;
}

# HTTPS-Server für die Hauptdomain
server {
    root /var/www/html;

    # Add index.php to the list if you are using PHP
    index index.html index.htm index.nginx-debian.html;

    server_name mrx3k1.de www.mrx3k1.de;

    # Globale CORS-Header
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

    # Generischer /games/ Block für andere Spiele (keine Überschneidung mit brain-buster)
    location ~ ^/games/(?!(brain-buster|darts|pong|schatten-ueber-palermo|sh00ter)).+$ {
        alias /var/www/html/games/;
        try_files $uri $uri.html $uri/ =404;
    }

    location /audio-cutter/ {
        alias /var/www/html/audio-cutter/build/;
        try_files $uri $uri/ /audio-cutter/index.html;
    }

    # MPSec Frontend
    location /mpsec {
        alias /var/www/html/mpsec/client/build/;
        try_files $uri $uri/ /mpsec/index.html;
        index index.html;
        # Verhindert Caching von index.html um App-Updates sofort zu sehen
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    # MPSec API Backend
    location /mpsec/api/ {
        proxy_pass http://localhost:5012/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # xchange PWA - Service Worker muss spezielle Header haben
    location = /xchange/sw.js {
        alias /var/www/html/xchange/public/sw.js;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Service-Worker-Allowed "/xchange/";
        expires off;
    }

    # xchange PWA - Manifest mit korrektem MIME-Type
    location = /xchange/manifest.json {
        alias /var/www/html/xchange/public/manifest.json;
        add_header Content-Type "application/json";
        add_header Cache-Control "public, max-age=86400";
    }

    # xchange PWA - Statische Assets (Bilder, Icons, etc.)
    location ~* ^/xchange/.*\.(png|jpg|jpeg|gif|ico|svg|css|js)$ {
        root /var/www/html/xchange/public;
        rewrite ^/xchange/(.*)$ /$1 break;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # xchange PWA - API Routen explizit zum Backend
    location ~ ^/xchange/(upload|files|download|status|login|authenticate|create-share|share) {
        proxy_pass http://localhost:5009;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        client_max_body_size 50M;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # xchange PWA - Hauptroute für statische Dateien
    location /xchange/ {
        alias /var/www/html/xchange/public/;
        index index.html;
        try_files $uri $uri/ /xchange/index.html;
    }

    # xchange PWA - Fallback für /xchange ohne trailing slash
    location = /xchange {
        return 301 /xchange/;
    }

    location /bartender/ {
        alias /var/www/html/bartender/build/;
        try_files $uri $uri/ /bartender/index.html;
        index index.html;
        # Prevent caching of index.html to see app updates immediately
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # If you decide to run a backend API server for this app later
    location /bartender/api/ {
        proxy_pass http://localhost:5024/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Brain-Buster SPA - KLARE PFADZUORDNUNG
    location /games/brain-buster/ {
        alias /var/www/html/games/brain-buster/;
        try_files $uri $uri/ /games/brain-buster/index.html;
    }

    location /games/darts/ {
        alias /var/www/html/games/darts/;
        try_files $uri $uri/ /games/darts/index.html;
    }

    location /games/schatten-ueber-palermo/ {
        alias /var/www/html/games/schatten-ueber-palermo/;
        try_files $uri $uri/ /games/schatten-ueber-palermo/index.html;
    }

    location /games/pong/ {
        alias /var/www/html/games/pong/;
        try_files $uri $uri/ /games/pong/index.html;
    }
    
    # WebSocket-Proxy für den BrainBuster-Multiplayer-Server
    location /socket-api/ {
        proxy_pass http://localhost:4999/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering off;
        proxy_redirect off;
    }

    location /seolytix/ {
        alias /var/www/html/seolytix/frontend/build/;
        try_files $uri $uri/ /seolytix/index.html;
        index index.html;
        
        # Für bessere Performance
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    }
    location /seolytix/api/ {
        proxy_pass http://localhost:5010/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }    

    location /weather-tracker/ {
        rewrite ^/weather-tracker/(.*) /$1 break;
        proxy_pass http://localhost:5033;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Debug-Logs
        access_log /var/log/nginx/weather-tracker-access.log;
        error_log /var/log/nginx/weather-tracker-error.log;
    }

    location /blog/ {
        proxy_pass http://localhost:4777/blog/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Erhöhe Timeouts falls nötig
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /drafts/ {
        alias /var/www/html/drafts/;
        try_files $uri $uri/ $uri.html /drafts/index.html =404;
    }

    location /techdocs/ {
        proxy_pass http://localhost:5007/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Erhöhe Timeouts falls nötig
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
 
    # Rest deiner bestehenden Konfiguration...
    location /gta/ {
        proxy_pass http://localhost:8001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /poker-advisor {
        alias /var/www/html/poker-advisor/build/;
        try_files $uri $uri/ /poker-advisor/index.html;
    }

    location /kiez-finder {
        alias /var/www/html/kiez-finder/dist/;
        try_files $uri $uri/ /kiez-finder/index.html;
    }

     
    location /glitter-hue {
        alias /var/www/html/glitter-hue/build/;
        try_files $uri $uri/ /glitter-hue/index.html;
        # Verhindert Caching von index.html um App-Updates sofort zu sehen
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    # Proxy-Server
    location /glitter-hue/hue/ {
        proxy_pass http://localhost:8081/hue/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Aktiviere Debug-Logging
        access_log /var/log/nginx/glitterhue-proxy-access.log;
        error_log /var/log/nginx/glitterhue-proxy-error.log debug;
        
        # Timeouts anpassen
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /philips-hue-controller {
        alias /var/www/html/philips-hue-controller/build/;
        try_files $uri $uri/ /philips-hue-controller/index.html;
    }

    location /free-wifi {
        alias /var/www/html/free-wifi/build/;
        try_files $uri $uri/ /free-wifi/index.html;
    }
    location /free-wifi/api/ {
        proxy_pass http://localhost:4800/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    location /zipzap {
        alias /var/www/html/zipzap/build/;
        try_files $uri $uri/ /zipzap/index.html;
    }
    location /zipzap/api/ {
        proxy_pass http://localhost:4997/api/;  # Slash am Ende wichtig
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    location /crypto-vault {
        alias /var/www/html/crypto-vault/build/;
        try_files $uri $uri/ /crypto-vault/index.html;
    }

    # Spezifische Konfiguration für linux-terminal-simulator
    location /linux-terminal-simulator/ {
        alias /var/www/html/linux-terminal-simulator/build/;
        try_files $uri $uri/ /linux-terminal-simulator/index.html;
    }

    location /greystone/ {
        alias /var/www/html/greystone/;
        try_files $uri $uri.html $uri/ =404;
    }

    location /games/darts-react/ {
        alias /var/www/html/games/darts-react/dist/;
        try_files $uri $uri/ /games/darts-react/index.html;
    }

    location /games/darts-react/api/ {
        # Aktiviere Debug-Logs für diesen Block
        access_log /var/log/nginx/darts-react-api-access.log;
        error_log /var/log/nginx/darts-react-api-error.log debug;
        
        # Die rewrite-Zeile ist kritisch für die korrekte API-Weiterleitung
        rewrite ^/games/darts-react/api/(.*) /$1 break;
        
        # Proxy zum Backend-Server
        proxy_pass http://localhost:5017;
        proxy_http_version 1.1;
        
        # Wichtige Headers für die korrekte Weiterleitung
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Web-Socket-Support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Cache-Kontrolle
        proxy_cache_bypass $http_upgrade;
        
        # Längere Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }


    location /games/sh00ter/ {
        alias /var/www/html/games/sh00ter/dist/;
        try_files $uri $uri/ /games/sh00ter/index.html;
    }

    location /jackson {
        alias /var/www/html/jackson/build/;
        try_files $uri $uri/ /jackson/index.html;
        
        # Für bessere Performance
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    }

    location /games/pong-react/ {
        alias /var/www/html/games/pong-react/build/;
        try_files $uri $uri/ /games/pong-react/index.html;
    }

    location /ai-playground-portal {
        alias /var/www/html/ai-playground-portal/build/;
        try_files $uri $uri/ /ai-playground-portal/index.html;
    }

    location /cliptune {
        alias /var/www/html/cliptune/build/;
        try_files $uri $uri/ /cliptune/index.html;
    }

    location /docs-portal {
        alias /var/www/html/docs-portal/build/;
        try_files $uri $uri/ /docs-portal/index.html;
    }

    location /jetbrains-ide-clone {
        alias /var/www/html/jetbrains-ide-clone/build/;
        try_files $uri $uri/ /jetbrains-ide-clone/index.html;
    }

    location /voice-xtract {
        alias /var/www/html/voice-xtract/client/build;
        try_files $uri $uri/ /voice-xtract/index.html;
        index index.html;
    }
    
    # Voice Extract API Backend - Einfachere Konfiguration
    location /voice-xtract/api/ {
        # Wichtig: Wir entfernen nur das /voice-xtract Präfix
        proxy_pass http://localhost:4992/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # Log für Debugging aktivieren
        access_log /var/log/nginx/voicextract-api-access.log;
        error_log /var/log/nginx/voicextract-api-error.log debug;
        
        # Größere Uploads erlauben
        client_max_body_size 500M;
    }

    location /objectcut-react/ {
        alias /var/www/html/objectcut-react/build/;
        try_files $uri $uri/ /objectcut-react/index.html;
        # Fallback für SPA-Routing
        index index.html;
    }
    # API-Anfragen mit /objectcut-react/api weiterleiten
    location /objectcut-react/api/remove-background {
        proxy_pass http://localhost:4991/api/remove-background;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Timeouts für große Bilder erhöhen
        proxy_read_timeout 600;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        
        # Max. Dateigröße erhöhen
        client_max_body_size 20M;
    }
    # Auch API-Anfragen ohne Präfix unterstützen (für direkten Zugriff)
    location /api/remove-background {
        proxy_pass http://localhost:4991/api/remove-background;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Timeouts für große Bilder erhöhen
        proxy_read_timeout 600;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        
        # Max. Dateigröße erhöhen
        client_max_body_size 20M;
    }

    location /weather/ {
        alias /var/www/html/weather/build/;
        index index.html;
        autoindex off;
        try_files $uri $uri/ /weather/index.html;
    }

    location /secret-content/ {
        alias /var/www/html/secret-content/client/build/;
        index index.html;
        try_files $uri $uri/ /secret-content/index.html;
    }

    # API-Proxy für den secret-content Backend-Server
    location /secret-content/api/ {
        proxy_pass http://localhost:4996/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }       

    # Generischer Fallback-Block
    location / {
        alias /var/www/html/;
        try_files $uri $uri/ @spa_fallback;
    }

    # SPA-Fallback für alle /stuff/-Unterordner
    location @spa_fallback {
        set $subdirectory "";
        if ($request_uri ~ "^/([^/]+)") {
            set $subdirectory $1;
        }

        # Prüfe zuerst auf build/index.html (für SPAs mit Build-Struktur)
        if (-f $document_root/$subdirectory/build/index.html) {
            rewrite ^/([^/]+)(.*)$ /$1/build/index.html break;
        }

        # Fallback auf direkte index.html im Unterordner
        if (-f $document_root/$subdirectory/index.html) {
            rewrite ^/([^/]+)(.*)$ /$1/index.html break;
        }

        # Wenn keine der beiden Dateien existiert, 404 zurückgeben
        return 404;
    }

    # WebSocket-Proxy für den Pong-Signaling-Server
    location /socket.io/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SSL-Konfiguration
    listen [::]:443 ssl ipv6only=on;
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/mrx3k1.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mrx3k1.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP zu HTTPS Weiterleitung für die Hauptdomain (nicht für hue.mrx3k1.de)
server {
    listen 80;
    listen [::]:80;
    
    # Wichtig: Die komplette Bedingung in einer Zeile, damit sie funktioniert
    if ($host ~ ^(www\.)?mrx3k1\.de$) {
        return 301 https://$host$request_uri;
    }
    
    # Diese Konfiguration gilt nur für die Hauptdomain, nicht für Subdomains
    server_name mrx3k1.de www.mrx3k1.de;
    
    # Bei falschem Host 404 zurückgeben
    return 404;
}